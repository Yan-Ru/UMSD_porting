# make.rules - common build rules
#
# modification history
# --------------------
# 05-08-2015,sundk	created from DSDT_3.5
#
########################################################################

ifeq ($(TARGET),)
TARGET	= $(notdir $(shell $(CD)))
endif
default : $(TARGET).o

# Set searching directories for target and dependencies
vpath %.o $(OBJDIR)

# Include DEPENDENCIES file if it exists
#ifeq ($(shell if [ -a $(DEPENDENCIES) ]; then $(ECHO) 1; fi),1)
ifeq ($(shell if [ -f $(DEPENDENCIES) ]; then $(ECHO) 1; fi),1)
include $(DEPENDENCIES)
endif

# Accumulate source files specified in each directory makefile
COBJECTS  = $(CSOURCES:.c=.o)
AOBJECTS  = $(ASOURCES:.s=.o)
ifeq ($(OBJECTS),)
OBJECTS  = $(COBJECTS) $(AOBJECTS)
endif

$(TARGET).o : $(OBJECTS) deps
	@ $(ECHO) 'Building $@'
	$(LD) $(LDFLAGS) -Map $(OUT_DIR)/$(OBJDIR)/$(TARGET).map -o $(OUT_DIR)/$(OBJDIR)/$(TARGET).o $(addprefix $(OUT_DIR)/$(OBJDIR)/,$(notdir $(OBJECTS)))

$(OBJECTS): %.o: %.c
.c.o :
#	@if ! [ -a $(OBJDIR) ]; then mkdir $(OBJDIR); fi
	@mkdir -p $(OUT_DIR)
	@if [ ! -d $(OUT_DIR)/$(OBJDIR) ]; then mkdir $(OUT_DIR)/$(OBJDIR); fi
	$(CC) $(CFLAGS) $(EXTRA_DEFINE) $(EXTRA_INCLUDE) $(ADDED_CFLAGS) -c $< -o $(OUT_DIR)/$(OBJDIR)/$(notdir $@)

deps : $(CSOURCES)
	@ $(ECHO) '##' > $(OUT_DIR)/$(DEPENDENCIES)
	@ $(ECHO) '## This file is generated by "make"!' >> $(OUT_DIR)/$(DEPENDENCIES)
	@ $(ECHO) '##' >> $(OUT_DIR)/$(DEPENDENCIES)
	@for i in $^ ; do \
		$(ECHO) "  $$i"; \
		$(CC) -M -MG $(CFLAGS) $$i >> $(OUT_DIR)/$(DEPENDENCIES);  \
		$(ECHO) '##' >> $(OUT_DIR)/$(DEPENDENCIES);	\
	done

.PHONY: clean
clean:
#	cd $(OUT_DIR)/$(OBJDIR); $(RM) *.o
#	cd $(OUT_DIR)/$(OBJDIR); $(RM) *.map
	$(RM) -f -r $(OUT_DIR)/$(OBJDIR)
	$(RM) $(OUT_DIR)/$(DEPENDENCIES)

FORCE :

# end of file
